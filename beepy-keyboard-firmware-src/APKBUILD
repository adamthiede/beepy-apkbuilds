# Contributor: Adam Thiede <me@adamthiede.com>
# Maintainer: Adam Thiede <me@adamthiede.com>
pkgname=beepy-keyboard-firmware-src
_modname=beepy-kbd
_modver=2.11
pkgver=1
pkgrel=0
pkgdesc="beepy bbq20 keyboard firmware"
url="https://github.com/ardangelo/beepberry-keyboard-driver"
arch="aarch64"
license="GPL-2.0-or-later"
depends="akms dtc linux-rpi-dev"
makedepends="linux-rpi-dev dtc"
source="$pkgname-$pkgver.tar.gz::https://github.com/adamthiede/beepberry-keyboard-driver/archive/refs/tags/$pkgver.tar.gz"
builddir="$srcdir/beepberry-keyboard-driver-$pkgver"
options="!check" #no tests

prepare() {
	default_prepare

	cat >AKMBUILD <<-EOF
	modname=$_modname
	modver=$_modver
	built_modules=$_modname.ko

	build() {
		make
	}
	EOF
}

build() {
	dtc -@ -I dts -O dtb -W no-unit_address_vs_reg -o beepy-kbd.dtbo beepy-kbd.dts
}

package() {
	install -Dm644 "$builddir"/beepy-kbd.map "$pkgdir"/usr/share/kbd/keymaps/beepy-kbd.map
	install -Dm644 "$builddir"/beepy-kbd.dtbo "$pkgdir"/boot/overlays/beepy-kbd.dtbo

	local destdir="$pkgdir/usr/src/$_modname-$pkgver"
	install -Dm644 -t "$destdir" AKMBUILD Makefile
	cp -r src beepy-kbd.dts "$destdir"
}

sha512sums="
5f266114070ae98baabca1199b3beb2f47a0eea61257650cbf4e2c23b20ff603b32fd0da9f374e0c8c05ea1122813e3dca2f966b96679b7aa18ddf1918a9a03b  beepy-keyboard-firmware-src-1.tar.gz
"
